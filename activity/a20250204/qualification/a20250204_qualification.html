<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>優惠資格判斷</title>
  <style>
    :root {
      --primary-color: #5cb85c;
      --border-color: #ddd;
      --bg-color: #f9f9f9;
      --text-color: #333;
      --error-color: #d44;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      line-height: 1.5;
      color: var(--text-color);
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
      background-color: #f5f5f5;
    }

    .container {
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    h1 {
      color: var(--text-color);
      margin-bottom: 1rem;
      font-size: 2rem;
      text-align: center;
    }

    .section {
      background: var(--bg-color);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .section-title {
      font-size: 1.2rem;
      font-weight: bold;
      margin-bottom: 1rem;
      color: var(--primary-color);
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .radio-group {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .radio-group label {
      display: flex;
      align-items: center;
      cursor: pointer;
    }

    input[type="radio"] {
      margin-right: 0.5rem;
      width: 1.2rem;
      height: 1.2rem;
    }

    input[type="date"] {
      width: 100%;
      padding: 0.8rem;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      font-size: 1rem;
    }

    button {
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 1rem 2rem;
      border-radius: 8px;
      font-size: 1.2rem;
      cursor: pointer;
      width: 100%;
      max-width: 400px;
      margin: 1.5rem auto;
      display: block;
      transition: background-color 0.3s;
    }

    button:hover {
      background-color: #4a994a;
    }

    #result {
      text-align: center;
      font-size: 1.2rem;
      font-weight: bold;
      color: var(--error-color);
      margin-top: 1rem;
      padding: 1rem;
      border-radius: 8px;
      background: #fff;
    }

    .activity-dates {
      text-align: center;
      margin: 1rem 0;
      padding: 0.8rem;
      background: #fff;
      border-radius: 8px;
      font-weight: bold;
    }

    .hidden {
      display: none;
    }

    /* 手機版樣式 */
    @media screen and (max-width: 768px) {
      body {
        padding: 10px;
        font-size: 16px;
      }

      .container {
        padding: 16px;
      }

      h1 {
        font-size: 1.5rem;
      }

      .section {
        padding: 1rem;
      }

      .radio-group {
        flex-direction: column;
        gap: 0.8rem;
      }

      .radio-group label {
        padding: 0.5rem 0;
      }

      input[type="radio"] {
        width: 1.4rem;
        height: 1.4rem;
      }

      input[type="date"] {
        padding: 1rem;
        font-size: 1.1rem;
      }

      button {
        padding: 1.2rem;
        font-size: 1.3rem;
        margin: 1rem auto;
      }

      #result {
        font-size: 1.3rem;
        padding: 1.2rem;
      }

      .section-title {
        font-size: 1.1rem;
      }

      .form-group {
        margin-bottom: 1.2rem;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>優惠資格判斷</h1>

    <div class="activity-dates">
      活動時間：2025/02/04 ~ 2025/03/31
      <span id="activityStatus"></span>
    </div>

    <!-- 客戶屬性 -->
    <div class="section">
      <div class="section-title">客戶屬性</div>
      <div class="radio-group">
        <label><input type="radio" name="customerType" value="new" checked> 新客</label>
        <label><input type="radio" name="customerType" value="old"> 舊客</label>
      </div>
    </div>

    <!-- 優惠類型 -->
    <div class="section">
      <div class="section-title">選擇優惠類型</div>
      <div class="radio-group">
        <label><input type="radio" id="type_single" name="discountType" value="single" checked> 單次小美</label>
        <label><input type="radio" id="type_monthly" name="discountType" value="monthly"> 包月服務</label>
      </div>
    </div>

    <div id="singleForm" class="section">
      <div class="section-title">單次小美條件</div>

      <div class="form-group">
        <div class="radio-group">
          <span>是否自行接送：</span>
          <label>
            <input type="radio" name="selfPickup_single" value="yes" checked>
            是 (符合)
          </label>
          <label>
            <input type="radio" name="selfPickup_single" value="no">
            否 (不符合)
          </label>
        </div>
      </div>

      <div class="form-group">
        <div class="radio-group">
          <span>是否提前3個工作天預約：</span>
          <label>
            <input type="radio" name="workDaysBeforeAppointment_single" value="yes" checked>
            是 (符合)
          </label>
          <label>
            <input type="radio" name="workDaysBeforeAppointment_single" value="no">
            否 (不符合)
          </label>
        </div>
      </div>

      <div class="form-group">
        <div class="radio-group">
          <span>是否提前或準時到店：</span>
          <label>
            <input type="radio" name="arriveOnTime_single" value="yes" checked>
            是 (符合)
          </label>
          <label>
            <input type="radio" name="arriveOnTime_single" value="no">
            否 (不符合)
          </label>
        </div>
      </div>

      <div class="form-group">
        <label for="lastVisitDate_single">距離上次來店日期：</label>
        <input type="date" id="lastVisitDate_single">
      </div>
    </div>

    <div id="monthlyForm" class="section hidden">
      <div class="section-title">包月條件</div>

      <!-- 包月條件檢查 -->
      <div class="section">
        <div class="section-title">包月條件檢查</div>

        <!-- 上次包月結束日期 -->
        <div class="radio-group">
          <label>上次包月結束日期：
            <input type="date" id="lastPackageEndDate">
          </label>
        </div>

        <!-- 本次包月首次使用日期 -->
        <div class="radio-group">
          <label>本次包月首次使用日期：
            <input type="date" id="thisPackageStartDate">
          </label>
        </div>

        <!-- 本次包月最後一次使用日期 -->
        <div class="radio-group">
          <label>本次包月最後一次使用日期：
            <input type="date" id="thisPackageEndDate">
          </label>
        </div>

        <!-- 是否每次提前預約 -->
        <div class="radio-group">
          <span>每次提前 3 個工作天預約：</span>
          <label><input type="radio" name="allAdvanceBooking" value="yes" checked> 是</label>
          <label><input type="radio" name="allAdvanceBooking" value="no"> 否</label>
        </div>

        <!-- 是否每次準時到店 -->
        <div class="radio-group">
          <span>每次準時到店：</span>
          <label><input type="radio" name="allOnTime" value="yes" checked> 是</label>
          <label><input type="radio" name="allOnTime" value="no"> 否</label>
        </div>

        <!-- 包月不得與其他狗共用 -->
        <div class="radio-group">
          <span>包月不得與其他狗共用：</span>
          <label><input type="radio" name="exclusiveUse" value="yes" checked> 是</label>
          <label><input type="radio" name="exclusiveUse" value="no"> 否</label>
        </div>
      </div>
    </div>

    <button id="checkButton" onclick="checkDiscount()">檢查優惠資格</button>
    <div id="result"></div>
  </div>

  <script src="../../../internal/checkAuth.js"></script>
  <script>
    //=== 活動日期設定 ===
    const startDate = new Date("2025-01-12T00:00:00");
    const endDate = new Date("2025-03-31T23:59:59");

    //=== 網頁載入後檢查是否已超過活動時間 ===
    window.addEventListener('DOMContentLoaded', () => {
      checkActivityPeriod();
      switchForm(); // 預設顯示單次小美區塊
    });

    //=== 檢查活動日期 ===
    function checkActivityPeriod() {
      const now = new Date();
      const activityStatusEl = document.getElementById('activityStatus');

      if (now < startDate) {
        // 活動尚未開始
        activityStatusEl.textContent = "（活動尚未開始）";
        // 也可以選擇是否做不可編輯處理
        disablePage(true);
      }
      else if (now > endDate) {
        // 活動已經結束
        activityStatusEl.textContent = "（活動已結束）";
        // 設為唯讀/不可點擊
        disablePage(false);
      }
      else {
        // 活動進行中
        activityStatusEl.textContent = "（活動進行中）";
      }
    }

    //=== 停用整頁 ===
    // 若參數為 true，則只顯示活動尚未開始的狀態
    // 若參數為 false，則顯示活動已結束的狀態
    function disablePage(isNotStarted) {
      // 使所有可互動的元素 (輸入框、按鈕等) 失效
      document.querySelectorAll('input, button').forEach(el => {
        el.disabled = true;
      });
      // 加上灰階效果提示
      document.body.classList.add('disabled-page');

      // 顯示不同提示文字
      if (isNotStarted) {
        document.getElementById('result').textContent = "活動尚未開始，暫時無法操作。";
      } else {
        document.getElementById('result').textContent = "活動已結束，感謝您的參與。";
      }
    }

    //=== 切換表單：根據優惠類型(單次/包月) 顯示/隱藏對應區塊 ===
    const typeRadios = document.querySelectorAll('input[name="discountType"]');
    typeRadios.forEach(radio => {
      radio.addEventListener('change', switchForm);
    });

    function switchForm() {
      const discountType = document.querySelector('input[name="discountType"]:checked').value;
      const singleForm = document.getElementById('singleForm');
      const monthlyForm = document.getElementById('monthlyForm');
      const result = document.getElementById('result');

      // 清空結果
      result.textContent = '';

      // 切換顯示
      if (discountType === 'single') {
        singleForm.classList.remove('hidden');
        monthlyForm.classList.add('hidden');
      } else {
        singleForm.classList.add('hidden');
        monthlyForm.classList.remove('hidden');
      }
    }

    //=== 檢查優惠資格 ===
    function checkDiscount() {
      console.log("開始檢查優惠資格...");

      // 1. 先確認新客或舊客
      const customerType = document.querySelector('input[name="customerType"]:checked').value;
      // new -> 新客, old -> 舊客

      // 2. 確認優惠類型
      const discountType = document.querySelector('input[name="discountType"]:checked').value;
      let resultText = "";
      let isQualified = false; // 紀錄是否符合優惠
      let discountInfo = "";  // 顯示折數

      // 3. 設定「新客 / 舊客 + 單次 / 包月」對應的折數
      //   新客： 單次小美 9折, 包月 95折
      //   舊客： 單次小美 8折, 包月 88折
      if (customerType === "new" && discountType === "single") {
        discountInfo = "9折";
      } else if (customerType === "new" && discountType === "monthly") {
        discountInfo = "95折";
      } else if (customerType === "old" && discountType === "single") {
        discountInfo = "8折";
      } else if (customerType === "old" && discountType === "monthly") {
        discountInfo = "88折";
      }

      if (discountType === "single") {
        //=== 檢查單次小美條件 ===
        console.log("檢查單次小美條件...");
        const selfPickup = document.querySelector('input[name="selfPickup_single"]:checked').value;
        const workDaysBeforeAppointment = document.querySelector('input[name="workDaysBeforeAppointment_single"]:checked').value;
        const arriveOnTime = document.querySelector('input[name="arriveOnTime_single"]:checked').value;
        if (!document.getElementById('lastVisitDate_single').value) {
          alert('請輸入最後一次來店日期');
          return false;
        }
        const lastVisitDate = new Date(document.getElementById('lastVisitDate_single').value);
        const daysBefore = calculateWorkingDays(lastVisitDate, new Date());

        // 簡易判斷 (可依需求自行調整)
        if (
          selfPickup === "yes" &&
          workDaysBeforeAppointment === "yes" &&
          arriveOnTime === "yes" &&
          daysBefore <= 12
        ) {
          isQualified = true;
        } else {
          isQualified = false;
        }

        if (isQualified) {
          resultText = `符合『單次小美』優惠資格，您可享「${discountInfo}」！`;
        } else {
          resultText = "不符合『單次小美』優惠資格。";
        }

      } else {
        //=== 檢查包月條件 ===
        console.log("檢查包月條件...");
        const lastPackageEndDate = new Date(document.getElementById("lastPackageEndDate").value);
        const thisPackageStartDate = new Date(document.getElementById("thisPackageStartDate").value);
        const thisPackageEndDate = new Date(document.getElementById("thisPackageEndDate").value);

        const allAdvanceBooking = document.querySelector('input[name="allAdvanceBooking"]:checked').value;
        const allOnTime = document.querySelector('input[name="allOnTime"]:checked').value;
        const exclusiveUse = document.querySelector('input[name="exclusiveUse"]:checked').value;

        const daysBetweenStartAndEnd = (thisPackageEndDate - thisPackageStartDate) / (1000 * 60 * 60 * 24);
        const daysSinceLastPackage = (thisPackageStartDate - lastPackageEndDate) / (1000 * 60 * 60 * 24);

        if (!document.getElementById('lastPackageEndDate').value) {
          alert('請輸入上次最後一次包月使用結束日期');
          return false;
        }

        if (!document.getElementById('thisPackageStartDate').value) {
          alert('請輸入本次包月第一次使用日期');
          return false;
        }

        if (!document.getElementById('thisPackageEndDate').value) {
          alert('請輸入本次包月最後一次使用日期');
          return false;
        }

        // 簡易判斷 (可依需求自行調整)
        if (
          daysBetweenStartAndEnd <= 35 &&
          daysSinceLastPackage <= 20 &&
          allAdvanceBooking === "yes" &&
          allOnTime === "yes" &&
          exclusiveUse === "yes"
        ) {
          resultText = `符合『包月』優惠資格，下一次包月您可享「${discountInfo}」 + 免費護毛一次（20天內有效）！`;
        } else {
          resultText = "不符合『包月』優惠資格。";
        }
      }

      //=== 顯示判斷結果 ===
      document.getElementById('result').textContent = resultText;
      console.log("檢查結束:", resultText);


      // 計算天數
      function calculateWorkingDays(startDate, endDate) {
        console.log("Calculating working days");
        let count = 0;
        let currentDate = new Date(startDate);

        // 不包含今天
        while (currentDate < endDate) {
          const day = currentDate.getDay();
          // if (day !== 0 && day !== 6 && day !== 1 && day !== 2) { // 排除周末和週一、週二
          //   count++;
          // }        
          count++;
          currentDate.setDate(currentDate.getDate() + 1);
        }
        return count;
      }

    }
  </script>

</body>

</html>